<script src="https://cdnjs.cloudflare.com/ajax/libs/gojs/1.6.7/go-debug.js"></script>
<div class="panel panel-default">

    <div class="panel-body" id="top-dashboard">
        افزونه
    </div>

</div>

<div  class="row" id="zone">

  <!--<div class="col-md-12" id="plugin-holder">

      <div class="item-holder">

           <div
                          ng-repeat="item in list5"
                          data-drop="true" ng-model='list5'
                          jqyoui-droppable="{index: {{$index}}}"
                  >
                      <div class="item "
                           ng-class="{'item-notify' : item.type=='notify', 'item-filter':item.type=='filter'  }"
                              data-drag="{{item.drag}}"
                              data-jqyoui-options="{revert: 'invalid'}"
                              ng-model="list5"
                              jqyoui-draggable="{index: {{$index}},placeholder:'keep',deepCopy:true}"
                              ng-hide="!item.title">
                          {{item.title}}
                      </div>
                  </div>
          <div class="clearfix"></div>
      </div>


      <div class='content'>
          <div class="row-fluid">
              <ul class="thumbnails">

                  <li class="span3" style='margin-left:10px;'>
                      <div class="thumbnail" data-drop="true" ng-model='vm.list1' jqyoui-droppable="{multiple:true}">
                          <div class="caption">
                              <div class="item"
                                   ng-class="{'item-notify' : item.type=='notify', 'item-filter':item.type=='filter'  }"
                                   ng-repeat="item in vm.list1"
                                   ng-show="item.title"
                                   data-drag="true"
                                   data-jqyoui-options="{revert: 'invalid'}"
                                   ng-model="vm.list1"
                                   jqyoui-draggable="{index: {{$index}},animate:true}"
                                   uib-popover-template="'filterTemplate.html'"
                              >
                                  {{item.title}}

                                  <script ng-if="item.type=='notify'" type="text/ng-template" id="filterTemplate.html">
                                      <div>
                                          In Notify Template
                                      </div>
                                      <div class="form-group">
                                          <label></label>
                                          <input type="text" placeholder="عنوان هشدار" class="form-control">
                                      </div>
                                  </script>

                                  <script ng-if="item.type=='filter'" type="text/ng-template" id="filterTemplate.html">
                                      <div>
                                          In Filter Template
                                      </div>
                                      <div class="form-group">
                                          <label></label>
                                          <input type="text" placeholder="عنوان فیلتر" class="form-control">
                                      </div>
                                  </script>

                              </div>
                          </div>
                      </div>
                  </li>

              </ul>
          </div>
      </div>

      {{vm.list1 | json}}

  </div>-->
    <div class="col-md-12" id="plugin-holder">
        <!-- new State -->
        <div style="padding: 15px;">
            <p ng-click="addState()" class="grow right-empty">New State +</p>
            <form name="sup-form" ng-submit="check(state)"
                  class="box state-box"  ng-repeat = "state in states track by $index">
                <p>State:
                    <input type="text" ng-blur="state['name']=checkForNull(state['name']);" ng-model="state['name']"  required>
                </p>
                <p>
                    Agent ID:
                    <select ng-model="state['agent_id']"  required>
                        <option></option>
                        <option ng-repeat="(keylid , value) in agents" ng-if="keylid != 'alerts'" ng-value="keylid">{{keylid}}</option>
                    </select>
                </p>
                <p>
                    type:
                    <select ng-model="state['type']" ng-options="x for x in stateTypes" required>
                        <option></option>
                    </select>
                </p>

                <!-- new condition -->
                <p ng-click="addCond(state)" ng-if="state['type'] == 'filter'" class="grow right-empty">New Condition +</p>
                <div  class="box condition-box" ng-if="state['type'] == 'filter'"
                     ng-model="state['conditions']" ng-repeat="cond in state['conditions'] track by $index">

                    <p>
                        Device ID:
                        <select ng-model="deviceConf"
                                ng-change="cond['device_id'] = deviceConf.device_id; cond['type'] = deviceConf.type;"
                                ng-options="value as value.device_id for  (key , value) in agents[state['agent_id']] |
                                 filter:{action_type: state['type']}" required>
                            <option></option>
                        </select>
                    </p>
                    <p>Type: <span ng-bind="cond['type']" ></span></p>
                    <p>
                        Action:
                        <select ng-model="actionNext"
                                ng-change="cond['action']['nextStep'] = actionNext.mindex"
                                ng-options="value.name for value in states" required>
                            <option></option>
                        </select>
                    </p>

                    <!-- new St -->
                    <p ng-click="addSt(cond)" class="grow right-empty">New State +</p>
                    <div class="box st-box"
                         ng-model=" cond['states']" ng-repeat="st in cond['states'] track by $index">

                        <p>
                            Type:
                            <select ng-model="st['type']"
                                    ng-options="value as value for  (key , value) in deviceConf.state" required>
                                <option></option>
                            </select>
                        </p>
                        <p>value: <input type="text" ng-model="st['value']" required></p>
                        <p>Op: <input type="text" ng-model="st['op']" required></p>
                        <p>Logic: <input type="text" ng-model="st['logic']"></p>

                        <i  class="fa fa-trash trash" ng-click="deleteSt(cond,st)" aria-hidden="true">
                        </i>

                    </div>
                    <br/>
                    <i class="fa fa-trash trash" ng-click="deleteCond(state,cond)">
                    </i>
                </div>

                <p ng-if="state['type'] == 'filter'" >
                    Else:
                    <select ng-model="elseNext"
                            ng-change="state['else']['nextStep'] = elseNext.mindex"
                            ng-options="value.name for value in states" required>
                        <option></option>
                    </select>
                </p>
                <p ng-if="state['type'] == 'notif'" >
                    Next Step:
                    <select ng-model="notifNext"
                            ng-change="state['nextStep'] = notifNext.mindex"
                            ng-options="value.name for value in states" required>
                        <option></option>
                    </select>
                </p>

                <!-- new Device -->
                <p ng-click="addAction(state)" ng-if="state['type'] == 'notif'" class="grow right-empty">New Device +</p>
                <div  class="box action-box" ng-if="state['type'] == 'notif'"
                      ng-model="state['actions']" ng-repeat="act in state['actions'] track by $index"
                      ng-init="act['agent_id'] = state['agent_id']">

                    <p>
                        Device ID:
                        <select ng-model="actionDevice"
                            ng-change="act['device_id'] = [actionDevice.device_id]; act['type'] = actionDevice.type;"
                            ng-options="value as value.device_id for  (key , value) in agents[state['agent_id']] |
                            filter:{action_type: state['type']}" required>
                            <option></option>
                        </select>
                    </p>

                    <p>Type: <span ng-bind="act['type']"></span></p>
                    <p>
                        Settings:
                        <select ng-model="settings_item"
                                ng-options="value as value.item for  (key , value) in actionDevice.settings"
                                ng-change="fillSettings(act,settings_item)" required>
                            <option></option>
                        </select>

                        <select ng-if="settings_item.item != undefined"
                                ng-model="act['settings'][settings_item.item]"
                                ng-options="x for x in settings_item.values" required>
                            <option></option>
                        </select>
                    </p>
                    <i class="fa fa-trash trash" ng-click="deleteAct(state,act)">
                    </i>
                </div>

                <!-- timer -->
                <div ng-if="state['type'] == 'timer'">
                    <p>
                        Interval Time:
                        <input type="text" ng-model="state['time']"  required>
                    </p>
                    <p>
                        Action:
                        <select ng-model="timerAction"
                                ng-change="state['action'] = timerAction.mindex"
                                ng-options="value.name for value in states" required>
                            <option></option>
                        </select>
                    </p>
                    <p>
                        NextStep:
                        <select ng-model="timerNext"
                                ng-change="state['nextStep'] = timerNext.mindex"
                                ng-options="value.name for value in states" required>
                            <option></option>
                        </select>
                    </p>
                </div>

                <!-- alert -->
                <div ng-if="state['type'] == 'alert'">
                    <p>
                        Alert Type:
                        <select ng-model="state['alert_type']"
                                ng-options="value for value in alertTypes" required>
                            <option></option>
                        </select>
                    </p>
                    <p>
                        To:
                        <span ng-if = "state['alert_type'] != 'telegram'">
                            <input list='toUsers' type="text" ng-model="state['to']"  required>
                            <datalist id="toUsers">
                                <option ng-if="state['alert_type'] == 'sms'" ng-repeat="item in agents.alerts.users" value="{{item['phone']}}"></option>
                                <option ng-if="state['alert_type'] == 'mail'" ng-repeat="item in agents.alerts.users" value="{{item['email']}}"></option>
                            </datalist>
                        </span>
                        <select ng-if ="state['alert_type'] == 'telegram'"
                                ng-model="state['to']"
                                ng-options="value.telegram_id as value.telegram_id + ' ( ' + value.name + ' )' for (key,value) in agents.alerts.users">
                            <option></option>
                        </select>
                    </p>

                    <p style="position: relative">
                        <span style="float: left; top: 5px;">Message:</span>

                        <textarea ng-model="state['message']" style="border-radius: 10px; min-width: 300px; min-height: 140px"/>
                    </p>

                    <p>
                        NextStep:
                        <select ng-model="alertNext"
                                ng-change="state['nextStep'] = alertNext.mindex"
                                ng-options="value.name for value in states" required>
                            <option></option>
                        </select>
                    </p>
                </div>

                <!--<button type="submit" >
                    Check
                </button>-->
                <br/>
                <i class="fa fa-trash trash" ng-click="deleteState(state)">
                </i>

            </form>
            <br/>
            <i class="fa fa-send send" ng-click="convertToVJson()" >
            </i>
            <div class="box">
                {{myjson}}
            </div>

            <div id="scenarioDiagram" style="width:100%; height:5000px; background-color: #DAE4E4;">

            </div>

        </div>
    </div>


</div>
